# PeriodProfitStopEA

期間累計損益に基づいて自動売買を停止するMT4/MT5用エキスパートアドバイザー（EA）です。

## 概要

指定した期間内の累計損益が目標金額に到達した際、または損失制限に達した際に、自動的にポジションを決済し自動売買を停止します。日次・週次などの損益管理に最適です。

## 主な機能

- ✅ **期間設定**: EA起動時から、または指定日時からの期間を選択可能
- 💰 **利益目標**: 累計利益が目標金額に達したら自動停止
- 🛑 **損失制限**: 累計損失が制限金額に達したら自動停止
- 🔄 **自動リセット**: 停止後、手動で自動売買をONにすると新しいサイクルを開始
- 🎨 **視覚的フィードバック**: 停止時に損益に応じて全体が緑色（利益）または赤色（損失）に変化
- 📊 **リアルタイム表示**: 見やすいパネルで累計損益を常時表示
- 🔊 **サウンド通知**: 目標達成時に音声で通知
- 🎯 **マジックナンバーフィルター**: 特定のEAのポジションのみを対象にすることも可能

## インストール方法

### MT4の場合
1. `PeriodProfitStopEA.mq4`と`PeriodProfitStopEA.mqh`、`AutoTradingControl.mqh`を`MQL4/Experts`フォルダにコピー
2. MetaEditorでコンパイル、またはMetaTrader 4を再起動
3. ナビゲーターウィンドウから`PeriodProfitStopEA`をチャートにドラッグ

### MT5の場合
1. `PeriodProfitStopEA.mq5`と`PeriodProfitStopEA.mqh`、`AutoTradingControl.mqh`を`MQL5/Experts`フォルダにコピー
2. MetaEditorでコンパイル、またはMetaTrader 5を再起動
3. ナビゲーターウィンドウから`PeriodProfitStopEA`をチャートにドラッグ

**重要**: EAの設定で「DLLの使用を許可する」にチェックを入れてください（自動売買の制御に必要）。

## パラメーター設定

### 期間設定
- **期間計算モード**: `EA起動時から` または `指定日時から`
- **開始日時**: 指定日時モード時の開始日時

### 損益目標設定
- **利益目標を有効化**: 利益目標機能のON/OFF
- **利益目標金額**: 目標とする利益額（デフォルト: 10,000）
- **損失制限を有効化**: 損失制限機能のON/OFF
- **損失制限金額**: 許容する最大損失額（デフォルト: 10,000）
- **目標達成時のアクション**:
  - `全決済＋EA停止`: ポジションを全決済してから自動売買を停止
  - `EAを停止のみ`: ポジションを保持したまま自動売買のみ停止

### 通知設定
- **サウンド通知を有効化**: 目標達成時の音声通知のON/OFF
- **通知サウンドファイル**: 使用する音声ファイル名（デフォルト: alert.wav）

### 表示設定
- **表示位置X座標**: パネルのX座標（デフォルト: 10）
- **表示位置Y座標**: パネルのY座標（デフォルト: 25）
- **フォントサイズ**: 表示文字のサイズ（デフォルト: 12）
- **フォント名**: 使用するフォント（デフォルト: MS Gothic）

### 決済設定
- **決済リトライ回数**: 決済失敗時のリトライ回数（デフォルト: 3）
- **リトライ間隔**: リトライ間の待機時間（ミリ秒、デフォルト: 1000）
- **マジックナンバー**: 対象とするポジションのマジックナンバー（0=全ポジション）

## 使い方

### 基本的な使い方

1. **EAを設定**: チャートに追加し、利益目標と損失制限を設定
2. **稼働開始**: 自動売買をONにすると計測開始
3. **自動停止**: 目標達成時に自動的に停止
4. **再スタート**: 手動で自動売買をONに戻すと自動リセットして新しいサイクル開始

### 使用例

#### 日次損益管理
- 期間計算モード: `EA起動時から`
- 利益目標金額: 10,000円
- 損失制限金額: 5,000円
- 目標達成時のアクション: `全決済＋EA停止`

毎朝EAを起動し、1日の利益が10,000円に達するか、損失が5,000円に達したら自動停止します。

#### 特定期間の損益管理
- 期間計算モード: `指定日時から`
- 開始日時: 2025/01/01 00:00
- 利益目標金額: 50,000円

特定の日から累計で50,000円の利益が出たら停止します。

## 表示パネルについて

チャート左上に表示されるパネルには以下の情報が表示されます：

- 📅 計算期間モード
- ⏰ 開始時刻
- 💵 開始残高 / 現在残高
- 📈 決済済損益（確定損益）
- 📊 含み損益（未確定損益）
- 💰 累計損益（決済済 + 含み損益）
- 🎯 利益目標までの残り金額
- ⚠️ 損失制限までの残り金額
- ✅ 稼働状態

### カラー表示
- **稼働中**: 通常の色で表示
- **停止時（利益達成）**: 全体が緑色に変化
- **停止時（損失到達）**: 全体が赤色に変化

## 注意事項

- ⚠️ **DLL使用許可が必須**: 自動売買の制御にDLL機能を使用します
- ⚠️ **バックテスト非対応**: DLL機能を使用するため、バックテストでは正常に動作しません
- ⚠️ **VPS推奨**: 安定した動作には24時間稼働のVPS環境を推奨
- ⚠️ **スリッページに注意**: 急激な相場変動時は目標金額と実際の決済額に差が生じる場合があります

## トラブルシューティング

### EAが動作しない
- DLLの使用を許可しているか確認してください
- エキスパートログでエラーメッセージを確認してください

### 決済が失敗する
- リトライ回数とリトライ間隔を増やしてみてください
- ネットワーク接続を確認してください

### 表示パネルが見えない
- 表示位置（X座標、Y座標）を調整してください
- チャートを拡大/縮小してみてください

## ライセンス

このEAはオープンソースです。自由に改変・配布できます。

## サポート

問題や要望がありましたら、GitHubのIssueでお知らせください。

---

**免責事項**: このEAの使用によって生じた損失について、開発者は一切の責任を負いません。自己責任でご使用ください。
